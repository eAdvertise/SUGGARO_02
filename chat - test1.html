<!doctype html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>SUGGARO</title>
    <meta name="description" content="">
    <meta name="keywords" content="" />
    <link rel="icon" type="image/png" href="assets/img/icons/favicon-32x32.png" sizes="32x32">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/img/icons/apple-icon-180x180.png">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/custom.css?v1.1">
    <link rel="manifest" href="assets/img/icons/manifest.json">
</head>
<body class="chat_page">

    <!-- loader -->
    <div id="loader">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
    <!-- * loader -->

    <!-- App Header -->
    <div class="appHeader bg-primary text-light">
        <div class="left">
            <a href="chatlist.html" class="headerButton">
                <ion-icon name="chevron-back-outline"></ion-icon>
            </a>
			<a href="#" class="headerButton">
                <!-- profile box -->
				<div class="CprofileBox pb-buttom">
					<div class="image-wrapper">
						<img src="assets/img/users/samples/12.jpg" alt="image" class="imaged rounded" id="user-avatar">
						<span class="badge badge-success badge-empty"></span>
					</div>
				   
					<div class="in">
						<strong id="user-username"></strong>
						<div class="text-muted">
							<img src="assets/img/flags/1x1/se.svg" alt="country">						
						</div>
					</div>
				</div>
				<!-- * profile box -- >
				<ion-icon name="menu-outline"></ion-icon>-->
            </a>
        </div>
        <div class="pageTitle"></div>
        <div class="right">
            <a onclick="notification('notification-ban')" class="headerButton">
                <ion-icon name="ban-outline"></ion-icon>
            </a>
                <!-- android style-->
                <div id="notification-ban" class="notification-box">
                    <div class="notification-dialog android-style">
                        <div class="notification-header">
                            <div class="in">
                                <img src="assets/img/sample/avatar/avatar6.jpg" alt="image" class="imaged w24 rounded">
                                <strong>Notification</strong>
                                <span>just now</span>
                            </div>
                            <a href="#" class="close-button">
                                <ion-icon name="close"></ion-icon>
                            </a>
                        </div>
                        <div class="notification-content">
                            <div class="in">
                                <h3 class="subtitle">File Uploaded!</h3>
                                <div class="text">
                                    Lorem ipsum dolor sit amet.
                                </div>
                            </div>
                        </div>
                        <div class="notification-footer">
                            <a href="#" class="notification-button">
                                <ion-icon name="close-circle"></ion-icon>
                                Close Window
                            </a>
                            <a href="#" class="notification-button">
                                <ion-icon name="ban"></ion-icon>
                                Go to your Blocked Users
                            </a>
                        </div>
                    </div>
                </div>
                <!-- * android style -->
            <a onclick="notification('notification-favorite')" class="headerButton">
                <ion-icon name="star-outline"></ion-icon>
            </a>
			
                <!-- android style-->
                <div id="notification-favorite" class="notification-box">
                    <div class="notification-dialog android-style">
                        <div class="notification-header">
                            <div class="in">
                                <img src="assets/img/sample/avatar/avatar6.jpg" alt="image" class="imaged w24 rounded">
                                <strong>Notification</strong>
                                <span>just now</span>
                            </div>
                            <a href="#" class="close-button">
                                <ion-icon name="close"></ion-icon>
                            </a>
                        </div>
                        <div class="notification-content">
                            <div class="in">
                                <h3 class="subtitle">File Uploaded!</h3>
                                <div class="text">
                                    Lorem ipsum dolor sit amet.
                                </div>
                            </div>
                        </div>
                        <div class="notification-footer">
                            <a href="#" class="notification-button">
                                <ion-icon name="close-circle"></ion-icon>
                                Close Window
                            </a>
                            <a href="#" class="notification-button">
                                <ion-icon name="star"></ion-icon>
                                Go to your Favorites
                            </a>
                        </div>
                    </div>
                </div>
                <!-- * android style -->
            <a href="#" class="headerButton" data-bs-toggle="offcanvas"  data-bs-target="#UserInfoSidebarPanel">
                <ion-icon name="reader-outline"></ion-icon>
            </a>
        </div>
    </div>
    <!-- * App Header -->

    <!-- App Capsule -->
    <div id="appCapsule">
		<div id="message-area">
                            
                           
        </div>
    </div>
    <!-- * App Capsule -->

    <!-- Add Action Sheet -->
    <div class="offcanvas offcanvas-bottom action-sheet inset" tabindex="-1" id="actionSheetAdd">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Share</h5>
        </div>
        <div class="offcanvas-body">
            <ul class="action-button-list">
                <li>
                    <a href="#" class="btn btn-list" data-bs-dismiss="offcanvas">
                        <span>
                            <ion-icon name="camera-outline"></ion-icon>
                            Take a photo
                        </span>
                    </a>
                </li>
                <li>
                    <a href="#" class="btn btn-list" data-bs-dismiss="offcanvas">
                        <span>
                            <ion-icon name="videocam-outline"></ion-icon>
                            Video
                        </span>
                    </a>
                </li>
                <li>
                    <a href="#" class="btn btn-list" data-bs-dismiss="offcanvas">
                        <span>
                            <ion-icon name="image-outline"></ion-icon>
                            Upload from Gallery
                        </span>
                    </a>
                </li>
                <li>
                    <a href="#" class="btn btn-list" data-bs-dismiss="offcanvas">
                        <span>
                            <ion-icon name="document-outline"></ion-icon>
                            Documents
                        </span>
                    </a>
                </li>
                <li>
                    <a href="#" class="btn btn-list" data-bs-dismiss="offcanvas">
                        <span>
                            <ion-icon name="musical-notes-outline"></ion-icon>
                            Sound file
                        </span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
    <!-- * Add Action Sheet -->

    <!-- chat footer -->
    <div class="chatFooter">
		
                       
            <a href="#" class="btn btn-icon btn-secondary rounded" data-bs-toggle="offcanvas"
                data-bs-target="#actionSheetAdd">
                <ion-icon name="add"></ion-icon>
            </a>
            <div class="form-group boxed">
                <div class="input-wrapper">
                    <input type="text" class="form-control" placeholder="Type a message..." id="console-message-input">
                    <i class="clear-input">
                        <ion-icon name="close-circle"></ion-icon>
                    </i>
                </div>
            </div>
			                   
            <button class="btn btn-icon btn-primary rounded" id="send-button">
                <ion-icon name="send"></ion-icon>
            </button>
    </div>
    <!-- * chat footer -->

    <!-- App Sidebar -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="UserInfoSidebarPanel">
        <div class="offcanvas-body">
            <!-- profile box -->
            <div class="profileBox">
                <div class="image-wrapper">
                    <img src="assets/img/users/samples/12.jpg" alt="image" class="imaged rounded">
					<span class="badge badge-success badge-empty"></span>
				</div>
                <div class="in">
                    <strong>DADDYLOVER_SE</strong>
                    <div class="text-muted">
						<img src="assets/img/flags/1x1/se.svg" alt="country">						
					</div>
                </div>
                <a href="#" class="close-sidebar-button" data-bs-dismiss="offcanvas">
                    <ion-icon name="close"></ion-icon>
                </a>
            </div>
            <!-- * profile box -->
			<div class="listview-text">
                
				<form>
                    <div class="form-group boxed">
                        <div class="input-wrapper">
                            <label class="form-label" for="notes">Make your own notice about <a href="#">DADDYLOVER_SE</a></label>
                            <textarea id="notes" rows="5" class="form-control"></textarea>
                            <i class="clear-input">
                                <ion-icon name="close-circle"></ion-icon>
                            </i>
                        </div>
                    </div>
                </form>
				
            </div>
			<div class="listview-text">
                
				<br/>
				You have transfer <span class="amount_transfered"> 670 USD</span> to <span class="user_transfered">DADDYLOVER_SE</span>
				<div class="divider bg-secondary mt-2 mb-3"></div>
				<div class="funds_transfered">
					<div class="scrollable-box">
						<div class="chip chip-media ms-05 mb-05">
							<span class="chip-label">11/05/23 > 30 USD</span>
							<i class="chip-icon bg-danger">
								<ion-icon name="remove-outline" role="img" class="md hydrated" aria-label="pin outline"></ion-icon>
							</i>
						</div>
						<div class="chip chip-media ms-05 mb-05">
							<span class="chip-label">15/04/23 > 60 USD</span>
							<i class="chip-icon bg-danger">
								<ion-icon name="remove-outline" role="img" class="md hydrated" aria-label="pin outline"></ion-icon>
							</i>
						</div>
						<div class="chip chip-media ms-05 mb-05">
							<span class="chip-label">02/04/23 > 20 USD</span>
							<i class="chip-icon bg-danger">
								<ion-icon name="remove-outline" role="img" class="md hydrated" aria-label="pin outline"></ion-icon>
							</i>
						</div>
						<div class="chip chip-media ms-05 mb-05">
							<span class="chip-label">14/03/23 > 110 USD</span>
							<i class="chip-icon bg-danger">
								<ion-icon name="remove-outline" role="img" class="md hydrated" aria-label="pin outline"></ion-icon>
							</i>
						</div>
						<div class="chip chip-media ms-05 mb-05">
							<span class="chip-label">12/03/23 > 100 USD</span>
							<i class="chip-icon bg-danger">
								<ion-icon name="remove-outline" role="img" class="md hydrated" aria-label="pin outline"></ion-icon>
							</i>
						</div>
						<div class="chip chip-media ms-05 mb-05">
							<span class="chip-label">11/02/23 > 200 USD</span>
							<i class="chip-icon bg-danger">
								<ion-icon name="remove-outline" role="img" class="md hydrated" aria-label="pin outline"></ion-icon>
							</i>
						</div>
						<div class="chip chip-media ms-05 mb-05">
							<span class="chip-label">02/01/23 > 150 USD</span>
							<i class="chip-icon bg-danger">
								<ion-icon name="remove-outline" role="img" class="md hydrated" aria-label="pin outline"></ion-icon>
							</i>
						</div>
					</div>
				</div>
            </div>
        </div>
        <!-- sidebar buttons -->
        <div class="sidebar-buttons">
            <a href="#" class="button">
                <ion-icon name="person-outline"></ion-icon>
            </a>
            <a href="#" class="button">
                <ion-icon name="archive-outline"></ion-icon>
            </a>
            <a href="#" class="button">
                <ion-icon name="settings-outline"></ion-icon>
            </a>
            <a href="#" class="button">
                <ion-icon name="log-out-outline"></ion-icon>
            </a>
        </div>
        <!-- * sidebar buttons -->
    </div>
   <!-- ============== Js Files ==============  -->
    <!-- Bootstrap -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="assets/js/lib/bootstrap.min.js"></script>
    <!-- Ionicons -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <!-- Splide -->
    <script src="assets/js/plugins/splide/splide.min.js"></script>
    <!-- ProgressBar js -->
    <script src="assets/js/plugins/progressbar-js/progressbar.min.js"></script>
    <!-- Base Js File -->
    <script src="assets/js/base.js"></script>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.1.1.js"></script>
    <script src="assets/js/app.js?v0.18"></script>
	<script>
		$(document).ready(function() {	
			if ((localStorage.getItem('contact_id') === null) || (localStorage.getItem('contact_id') === "undefined") || localStorage.getItem('contact_id') === " ") {
				window.location = "./login.html";
			}
		});
		var user = getUrlVarss()["user"];
		var contact = getUrlVarss()["contact"];
		var user_username;
		var gender;
		var role;
		var country;
		var user_location;
		var birthday;
		var age;
		var daysonsuggaro;
		var postdata = {
				id: user,
				contactid: contact
			};
		$.ajax({    
			type: "POST",
			url: "https://suggaro.eadcloud.eu/API/get_contact.php",             
			data: postdata,
			dataType: "json",
			encode: true,                  
			success: function(data){
				arr = data['customfields']; 
				if(data['profile_image']!=null){
					$("#user-avatar").attr("src","https://suggaro.eadcrm.eu/uploads/client_profile_images/" + contact + "/thumb_" + data['profile_image']);
					
				}
				$.each(arr, function(key, customefield){
					if(customefield.label === "Username"){
						$("#user-username").html(customefield.value);
						user_username = customefield.value;	
						localStorage.setItem(user_username + "_pic", "https://suggaro.eadcrm.eu/uploads/client_profile_images/" + contact + "/thumb_" + data['profile_image']);						
					}
					if(customefield.label === "Gender"){
						gender = customefield.value;
					}
					
					if(customefield.label === "Country"){
						country = customefield.value;
					}
					if(customefield.label === "Location"){
						user_location = customefield.value;
					}
					if(customefield.label === "Role"){
						role = customefield.value;
					}
					
				});	
				
			}
						
		});
		function getUrlVarss(){var vars = {};var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {vars[key] = value;});return vars;}
		
	</script>
    <script>
		
        (function() {
            // bind the Enter key to send-button click event
            $(document).keypress(function(e){
                if (e.which == 13){
                    $("#send-button").click();
                }
            });

            //Init & Subscribe
            //var chat_channel = user_username + "-" + localStorage.getItem("username");
            var pubkey = "pub-c-2c0ea513-d356-4b8c-b10b-884046854f75"; // use your own pub-key
            var subkey = "sub-c-a9e942de-be54-4067-ae49-d0525a9ecef7"; // use your own sub-key

            var username = localStorage.getItem("username");
            var city = "Paphos";
            var country = "CY";

            var myState = {
                'username': username,
                'location': user_location
            };

            if (localStorage.getItem('profileExists')) {
                //initalize the userState from localstorage..
                //you could also retrieve a user profile from your backend systems
                myState.username = localStorage.getItem("username");
                myState.location = localStorage.profileLocation;
            }

            var myUUID = localStorage.getItem(subkey + "uuid");
            var lastTimeToken = localStorage.getItem(subkey);

            console.log('local storage had: ' + myUUID + ' for uuid and ' + ' ' + lastTimeToken);

            if (lastTimeToken === null) {
                console.log('not using last token');
                lastTimeToken = 0; //make it zero
            }

            if (myUUID === null) {
                myUUID = PubNub.generateUUID();
            }

            var pubnub = new PubNub({
                publishKey:        pubkey,
                subscribeKey:      subkey,
                logVerbosity:      false,
                uuid:              myUUID,
                ssl:               true,
                heartbeatInterval: 60
            });

            // ************************************
			// * User A and User B become friends
			// ************************************

			// Add User B to User A's groups: Add ch-user-b-present to cg-user-a-friends
			pubnub.channelGroups.addChannels(
			  {
				channels: ["ch-user-" + user + "-present"],
				channelGroup: "cg-user-" + localStorage.getItem('contact_id') + "-friends"
			  },
			  function(status) {
				if (status.error) {
				  console.log("operation failed w/ status: ", status);
				}
				else {
				  console.log("Channel added to channel group");
				}
			  }
			);

			// Add User B to User A's groups: ch-user-b-status to cg-user-a-status-feed
			pubnub.channelGroups.addChannels(
			  {
				channels: ["ch-user-" + user + "-status"],
				channelGroup: "cg-user-" + localStorage.getItem('contact_id') + "-status-feed"
			  },
			  function(status) {
				if (status.error) {
				  console.log("operation failed w/ status: ", status);
				}
				else {
				  console.log("Channel added to channel group");
				}
			  }
			);

			// Add User A to User B's groups: Add ch-user-a-present to cg-user-b-friends
			pubnub.channelGroups.addChannels(
			  {
				channels: ["ch-user-" + localStorage.getItem('contact_id') + "-present"],
				channelGroup: "cg-user-" + user + "-friends"
			  },
			  function(status) {
				if (status.error) {
				  console.log("operation failed w/ status: ", status);
				}
				else {
				  console.log("Channel added to channel group");
				}
			  }
			);

			// Add User B to User A's groups: ch-user-a-status to cg-user-b-status-feed
			pubnub.channelGroups.addChannels(
			  {
				channels: ["ch-user-" + localStorage.getItem('contact_id') + "-status"],
				channelGroup: "cg-user-" + user + "-status-feed"
			  },
			  function(status) {
				if (status.error) {
				  console.log("operation failed w/ status: ", status);
				}
				else {
				  console.log("Channel added to channel group");
				}
			  }
			);
			
			// Get the List of Friends
			pubnub.channelGroups.listChannels(
			  {
				channelGroup: "cg-user-" + localStorage.getItem('contact_id') + "-friends"
			  },
			  function (status, response) {
			  if (status.error) {
				console.log("operation failed w/ error:", status);
				return;
			  }

				console.log("FRIENDLIST: ")
				response.channels.forEach( function (channel) {
				  console.log(channel);
				});
			  }
			);

			// Which Friends are online right now
			pubnub.hereNow(
			  {
				channelGroups: ["cg-user-" + localStorage.getItem('contact_id') + "-friends"]
			  },
			  function (status, response) {
				if (status.error) {
				  console.log("operation failed w/ error:", status);
				}
				else {
				  console.log("ONLINE NOW: ", response);
				}
			  }
			);

			// Watch Friends come online / go offline
			pubnub.subscribe({channelGroups:["cg-user-" + localStorage.getItem('contact_id') + "-friends"]});	
			pubnub.addListener({
                message: function(event) {
                    lastTimeToken = event.timetoken;
                    var formattedTime = UI.formatTimeToken(lastTimeToken);
                    var text = event.message.text;
                    var fromUser = event.message.from;
					console.log("STATUS: ", message);
                    UI.addChatMessage(text, formattedTime, fromUser);
                },

                presence: function(event) {
                    var action = event.action;
                    var channel = event.channel;
                    var uuid = event.uuid;
                    var data = event.state;
                    var occupancy = event.occupancy;
                    console.log("");
                    console.log("*** presence event ***");
                    console.log("action:    " + action);
                    console.log("channel:   " + channel);
                    console.log("uuid:      " + uuid);
                    console.log("occupancy: " + occupancy);
                    console.log("data:      " + JSON.stringify(data));
                    console.log("*** presence event ***");
                    console.log("");

                    if (action === "join") {
                        //UI.updateRoomCount(occupancy);
                    } 
                    else if ((action === "timeout") || (action === "leave")) {
                        //UI.handleLeaveEvent(event); 
                    }
                    else if (action === "state-change") {
                        console.log("!!!@@@ state-change event @@@!!!");
                        UI.handleStateChange(event.uuid, event.state);
                    } 

                },

                status: function(event) {
                    if (event.category === "PNConnectedCategory") {
                        pubnub.hereNow(
                            {
                                channelGroups: ["cg-user-" + localStorage.getItem('contact_id') + "-friends"],
                                includeUUIDs: true,
                                includeState: true
                            }, 
                            function (status, response) {
                                if (status.error) {
								  console.log("operation failed w/ error:", status);
								}
								else {
									console.log("ONLINE NOW: ", response);
									sendStateUpdate();
									// only one channel for this app, so we don't need to iterate over channels
									// get the channel by name and then get the uuids and state for each occupant
									//UI.updateRoomCount(response.channels[chat_channel].occupancy);
									response.channels["ch-user-" + user + "-present"].occupants.forEach(
										function(item) {
											if (item.state)
												UI.handleStateChange(item.uuid, item.state);
										}
									);
								}
							}
                        );
						

                        // just get us last 100 messages
                        // but you could just get messages since
                        // last time you received a message
                        // or just get last 5 minutes of messages
                        pubnub.history(
                            {
                                channel: "ch-user-" + user + "-present",
                                includeTimetoken: true,
                                count: 100 // the default
                            },
                            function (status, response) {
                                response['messages'].forEach(
                                    function(msg) {
                                        UI.addChatMessage(
                                            msg.entry.text, 
                                            UI.formatTimeToken(msg.timetoken), 
                                            msg.entry.from
                                        );
                                    }
                                );
                            }
                        );
                    }
                },
            });

			// Get Status Feed Messages
			pubnub.subscribe({channelGroups: ["cg-user-" + localStorage.getItem('contact_id') + "-status-feed"]});
            function sendStateUpdate() {
                localStorage.setItem('profileExists', true);

                pubnub.setState(
                    {
                        channels: ["ch-user-" + user + "-present"],
                        uuid: myUUID,
                        state: myState
                    },
                    function(response) {
                        console.log("setState on sendStateUpdate: " + JSON.stringify(response));
                    }
                );
            }

            /** 
             * this function publishes the text in the input text to pubnub, anyone subscribed to the channel will recieve 
             * the message
             **/
            function publish() {
                var messageText = document.querySelector("#console-message-input");
                var msg = {
                    from: myState.username,
                    text: messageText.value
                };

                pubnub.publish(
                    {
                        message: msg,
                        channel: ["ch-user-" + localStorage.getItem('contact_id') + "-present"]
                    }, 
                    function (status, response) {
                        if (status.error) {
                            console.log(status);
                        } 
                        else {
                            console.log("message Published with timetoken", response.timetoken);
                        }
                    }
                );

                messageText.value = '';
            }

            //reference to the send button element
            var messageSend = document.querySelector("#send-button");
            messageSend.onclick = publish;
            
        })()
    </script>
</body>

</html>